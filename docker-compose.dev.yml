# Docker Compose Development Override
# 
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
#   OR
#   make dev  (if using Makefile with the target)
#
# This file overrides production settings for local development:
# - Enables hot reload (uvicorn --reload)
# - Mounts source code for live editing
# - Enables DEBUG mode
# - Exposes PostgreSQL port for external tools
# - Includes MinIO for S3-compatible testing (no real S3 credentials needed)

services:
  # PostgreSQL port is NOT exposed by default to avoid conflicts
  # If you need external DB access, set POSTGRES_PORT in .env.local:
  #   POSTGRES_PORT=5433
  # Or uncomment below:
  # postgres:
  #   ports:
  #     - "${POSTGRES_PORT:-5432}:5432"

  minio:
    image: minio/minio:latest
    container_name: s3manager-minio
    command: server /data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "127.0.0.1:${MINIO_PORT:-9000}:9000"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  minio-init:
    image: minio/mc:latest
    container_name: s3manager-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      sh -c "
        mc alias set local http://minio:9000 minioadmin minioadmin &&
        mc mb local/test-bucket --ignore-existing || true
      "
    restart: "no"

  s3manager:
    # Mount source code for hot reload
    volumes:
      - ./backend/app:/app/app
      - ./backend/alembic:/app/alembic
      - ./backend/alembic.ini:/app/alembic.ini
      - ./backend/app/static:/app/app/static:ro
    environment:
      - APP_ENV=local
      - DEBUG=true
      - DEBUG_SQL=false
      - LOG_LEVEL=debug
    # Override command to enable auto-reload on code changes
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir /app/app
    depends_on:
      minio-init:
        condition: service_completed_successfully

  celery:
    # Mount source code so Celery workers also see changes
    volumes:
      - ./backend/app:/app/app
      - ./backend/alembic:/app/alembic
      - ./backend/alembic.ini:/app/alembic.ini
    environment:
      - APP_ENV=local
      - DEBUG=true
      - LOG_LEVEL=debug
    depends_on:
      minio-init:
        condition: service_completed_successfully

volumes:
  minio_data:
